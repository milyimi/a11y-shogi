# ユーザーフロー

## 1. 初回訪問フロー

```
ユーザーがアプリにアクセス
    ↓
├─ ホーム画面表示
│   ├─ "新しい対局を始める" ボタン
│   ├─ "過去の対局を再開" ボタン（セッション有の場合）
│   ├─ "はじめての方へ" 操作ガイドボックス ★実装済み
│   │   └─ 矢印キー・Enter・B・Sキーの簡潔な説明
│   └─ "詳しい操作方法を見る" リンク
│
├─ スクリーンリーダー対応ページ読み上げ
│
└─ ユーザー入力待機
```

## 2. 新規対局開始フロー

```
"新しい対局を始める" クリック/Enter
    ↓
難易度選択画面へ遷移
    ├─ ラジオボタン: 初級 / 中級 / 上級
    ├─ 説明文: 各難易度の特徴
    └─ "開始" / "キャンセル" ボタン
    ↓
セッション作成
    ↓
初期盤面生成（最初の数手までの定石）
    ↓
対局画面へ遷移
    ↓
初期ガイダンスをaria-liveでアナウンス ★実装済み
    └─ "対局を開始しました。あなたの手番です。
       矢印キーで盤面を移動、Enterで駒を選択・移動します。
       Bキーで盤面全体の読み上げ、Hキーでヘルプページを開きます。"
```

## 3. 対局中フロー - 人間（先手）のターン

```
人間ターン開始
    ├─ スクリーンリーダー: "あなたの番です。"
    │
    ├─ ユーザーが指し手を入力
    │   ├─ キーボード操作
    │   │   ├─ 矢印キー: 駒選択・移動
    │   │   ├─ Enter: 指し手実行
    │   │   └─ Esc: 選択キャンセル
    │   │
    │   └─ または 座標入力
    │       ├─ "7g-7f" 形式で入力
    │       └─ Enter で実行
    │
    ├─ 指し手検証 (バックエンド)
    │   ├─ 座標の有効性チェック
    │   ├─ 駒の所有者確認
    │   ├─ 移動ルール確認
    │   ├─ 王手判定
    │   └─ チェックメイト判定
    │
    ├─ OK: 局面更新 & 音声フィードバック
    │   └─ "7列目から7列目へ歩を移動。"
    │
    ├─ NG: エラーメッセージ表示
    │   └─ スクリーンリーダー: "その指し手は不正です。"
    │
    └─ AIターンへ遷移
```

## 4. 対局中フロー - AI（後手）のターン

```
AIターン開始
    ├─ スクリーンリーダー: "AIが考え中です..."
    │
    ├─ AIが指し手を生成 (バックエンド)
    │   ├─ 難易度に応じた評価関数で最適手を計算
    │   └─ ランダム性を追加（初級では高い）
    │
    ├─ 0.5〜2秒の遅延（リアリティのため）
    │
    ├─ 局面更新 & 音声フィードバック
    │   └─ "AIが2列目から3列目へ歩を移動。"
    │
    └─ ゲーム状態チェック
        ├─ チェックメイト: 終了画面へ
        ├─ 引き分け: 終了画面へ
        └─ 継続: 人間ターンへ
```

## 5. ゲーム終了フロー

```
終了条件判定
    ├─ チェックメイト (AI or Human)
    ├─ 引き分け (相互合意 or 規則)
    ├─ 投了
    └─ 時間切れ（将来実装）
    ↓
終了画面表示
    ├─ 結果表示
    │   └─ "あなたの勝ちです。"
    │       or "AIの勝ちです。"
    │       or "引き分けです。"
    │
    ├─ 棋譜表示
    │   ├─ テキスト形式（棋譜再生対応）
    │   └─ 音声での指し手読み上げ
    │
    ├─ 統計情報
    │   ├─ 対局時間
    │   ├─ 手数
    │   └─ AIの強さ
    │
    ├─ ゲーム終了後の操作制限 ★実装済み
    │   ├─ 駒の移動を禁止（フロントエンド・バックエンド両方）
    │   ├─ 成り確認ダイアログの非表示
    │   └─ 「ゲームは終了しています」メッセージ表示
    │
    ├─ ランキング登録ダイアログ ★実装済み
    │   ├─ 自動表示（ゲーム終了直後、リロード不要）
    │   ├─ role="dialog", aria-modal="true" で実装
    │   ├─ 勝利シナリオ
    │   │   ├─ タイトル: "🎉 ランキングに登録しますか？"
    │   │   ├─ ニックネーム入力フォーム（3～15文字）
    │   │   │   └─ オートフォーカス対応
    │   │   ├─ 難易度の明示（初級/中級/上級）
    │   │   ├─ "登録する" ボタン（有効）
    │   │   └─ "スキップ" ボタン
    │   ├─ 敗北シナリオ ★実装済み
    │   │   ├─ タイトル: "対局が終了しました"
    │   │   ├─ メッセージ: "今回はランキング登録の対象外です。ランキングを見ることができます。"
    │   │   ├─ ニックネーム入力フォーム（非表示）
    │   │   ├─ "登録する" ボタン（非表示・無効化）
    │   │   └─ "閉じる" ボタン
    │   ├─ Escapeキーで閉じる機能 ★実装済み
    │   │   └─ aria-live で勝利/敗北に応じたアナウンス
    │   ├─ 登録成功時の処理 ★実装済み
    │   │   ├─ ダイアログを閉じる
    │   │   ├─ 「○位に登録されました！」をaria-liveでアナウンス
    │   │   ├─ 情報パネルに「ランキングを見る」リンクを追加
    │   │   └─ リンクにフォーカス移動（preventScroll: true）
    │   └─ スキップ/閉じるボタン時の処理
    │       ├─ ダイアログを閉じる
    │       └─ aria-liveで勝利/敗北に応じたアナウンス
    │
    ├─ ページリロード時のダイアログ状態管理 ★実装済み
    │   ├─ リセット後も複数回ダイアログが表示される
    │   ├─ dataset.shown フラグで重複表示を防止
    │   └─ ページ初期化時にフラグをリセット
    │
    └─ 次のアクション
        ├─ "ランキングを見る" ★実装済み（登録後に動的追加）
        ├─ "新しい対局を始める"
        ├─ "棋譜を再生する"
        └─ "ホームに戻る"
```

## 6. キーボード操作フロー

```
盤上での操作シーケンス:

1. ナビゲーション
   ↑↓←→  : カーソル移動
   Tab    : 次のフォーカス対象へ

2. 駒の選択 & 移動
   Enter  : 駒選択（選択済みなら移動）
   Space  : 選択した駒の情報読み上げ
   Esc    : 選択キャンセル

3. 情報取得
   H      : ヘルプ表示
   B      : 全盤面の状態読み上げ
   L      : 最後の指し手読み上げ
   M      : 合法手一覧読み上げ

4. ゲーム制御
   U      : 棋譜を戻す（AI戦は2手戻す）
   R      : ゲームをリセット ★実装済み
           ├─ 確認ダイアログ表示
           ├─ 盤面を初期状態に戻す
           ├─ 手数をリセット（0手）
           ├─ 経過時間をリセット（0秒） ★実装済み
           ├─ ランキング登録ダイアログのフラグをリセット
           └─ ページを再読み込み
   Q      : ゲーム放棄（確認あり）
   S      : ゲーム状態を音声で報告
```

## 7. セッション復帰フロー

```
ユーザーが再度訪問
    ↓
セッションがあるか確認
    ├─ YES: 続行中の対局がある
    │       ↓
    │       "前の対局を再開しますか？" ダイアログ
    │       ├─ YES: 局面を復元して対局画面へ
    │       └─ NO: ホーム画面へ
    │
    └─ NO: 新規対局開始フロー
```

## 8. タイムアウト警告フロー（WCAG 2.2.1 対応）

```
対局中、セッションタイムアウト5分前
    ↓
警告ダイアログ表示
    ├─ role="alertdialog"
    ├─ aria-live="assertive"
    └─ 音声フィードバック
    ↓
"セッションがあと5分で期限切れになります"
"対局を続けますか？"
    ├─ "延長する" ボタン（セッションを120分延長）
    ├─ "保存して終了" ボタン
    └─ "このまま続ける" ボタン
    ↓
[延長する] を選択
    ↓
セッションタイムアウトがリセット
    ↓
"セッションを延長しました。" 通知
    ↓
対局画面に戻る

[保存して終了] を選択
    ↓
現在の局面を保存
    ↓
ホーム画面へ遷移

[タイムアウト発生時]
    ↓
自動保存実行
    ↓
"セッションが期限切れになりました。
 次回ログイン時に対局を再開できます。" 通知
    ↓
ホーム画面へリダイレクト
```

## 9. アクセシビリティキー表示フロー

```
初回アクセス or ユーザーが "H" キー押下
    ↓
ダイアログでキーボードショートカット表示
    ├─ テーブル形式
    ├─ 高コントラスト対応
    └─ スクリーンリーダー完全対応
    ↓
ユーザーがダイアログを閉じるまでブロッキング
    （通常操作可能にすることも検討）
```

## ユーザーシナリオ例

### シナリオ1: スクリーンリーダー利用者（初級AIとの対局）

```
1. NVDA で "a11y-shogi へようこそ。ホーム画面です。
   ナビゲーション: 新しい対局を始める、過去の対局を再開" 読み上げ
   
2. Tab で "新しい対局を始める" にフォーカス、Enter

3. "難易度選択。ラジオボタン3つあります" (NVDA)

4. ↓ で "初級 - ランダムな手を選びます" を選択

5. Enter で難易度確定

6. "対局を開始しました。あなたの手番です。
   矢印キーで盤面を移動、Enterで駒を選択・移動します。
   Bキーで盤面全体の読み上げ、Hキーでヘルプページを開きます。" (NVDA)

7. B キーで盤面を行ごと（段ごと）読み上げ

8. "7列目 7段から 7列目 6段へ歩を移動" と入力

9. Enter で指し手実行

10. "AIが 2列目 3段へ歩を移動しました。あなたのターンです。"

... 対局継続 ...
```

### シナリオ2: キーボード操作ユーザー（中級AIとの対局）

```
1. ↓ で "新しい対局を始める" にフォーカス、Enter

2. ↓ で "中級" を選択、Enter

3. ↑↑↑↑← でカーソルを移動

4. Space で駒情報確認 "7g の歩"

5. ↓ でターゲット選択、Enter で移動

... 以降同様 ...
```
